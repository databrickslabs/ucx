# Crawler/applier logic and data structures

On a very high-level, the permissions inventorization process is split into two steps:
1. collect all existing permissions into a persistent storage.
2. apply the collected permissions to the target resources.

The first step is performed by the `Crawler` and the second by the `Applier`.

Crawler and applier are intrinsically connected to each other due to SerDe (serialization/deserialization) logic.

We implement separate crawlers and applier for each supported resource type.

Please note that `table ACLs` logic is currently handled separately from the logic described in this document.

## Logical objects and relevant APIs

| Logical group | Resource type      | Object ID          | Listing method             | Get method                                   | Put method                                      | Object type                                    | Details                                                                                                    |
|---------------|--------------------|--------------------|----------------------------|----------------------------------------------|-------------------------------------------------|------------------------------------------------|------------------------------------------------------------------------------------------------------------|
| Group level   | Entitlements       | `group_id`         | `ws.groups.list`           | `ws.groups.get(group_id)`                    | `ws.groups.patch(group_id)`                     | Custom                                         | (One of `workspace-access`, `databricks-sql-access`, `allow-cluster-create`, `allow-instance-pool-create`) |
| Group level   | Roles              | `group_id`         | `ws.groups.list`           | `ws.groups.get(group_id`                     | `ws.groups.patch(group_id`                      | Custom                                         | (AWS only, represents instance profiles)                                                                   |
| Compute infra | Clusters           | `cluster_id`       | `ws.clusters.list`         | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Compute infra | Cluster policies   | `policy_id`        | `ws.cluster_policies.list` | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Compute infra | Instance pools     | `instance_pool_id` | `ws.instance_pools.list`   | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Compute infra | SQL warehouses     | `id`               | `ws.warehouses.list`       | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workflows     | Jobs               | `job_id`           | `ws.jobs.list`             | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workflows     | Delta Live Tables  | `pipeline_id`      | `ws.pipelines.list`        | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| ML            | MLflow experiments | `experiment_id`    | custom listing             | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| ML            | MLflow models      | `id`               | custom listing             | `ws.permissions.get(object_id, object_type)` | `ws.permissions.update(object_id, object_type)` | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| SQL           | Alerts             | `id`               | `ws.alerts.list`           | `ws.dbsql_permissions.get`                   | `ws.dbsql_permissions.set`                      | `databricks.sdk.service.sql.GetResponse`       | Note that API has no support for UPDATE operation, only PUT (overwrite) is supported.                      |
| SQL           | Dashboards         | `id`               | `ws.dashboards.list`       | `ws.dbsql_permissions.get`                   | `ws.dbsql_permissions.set`                      | `databricks.sdk.service.sql.GetResponse`       | Note that API has no support for UPDATE operation, only PUT (overwrite) is supported.                      |
| SQL           | Queries            | `id`               | `ws.queries.list`          | `ws.dbsql_permissions.get`                   | `ws.dbsql_permissions.set`                      | `databricks.sdk.service.sql.GetResponse`       | Note that API has no support for UPDATE operation, only PUT (overwrite) is supported.                      |
| Security      | Tokens             | ???                |                            |                                              |                                                 |                                                | token permissions are set on the workspace level. It basically says "this group can use tokens or not".    |
| Security      | Passwords          | ???                |                            |                                              |                                                 |                                                | Only for AWS, it defines which groups can log in with passwords                                            |
| Security      | Secrets            | `scope_name`       | `ws.secrets.list_scopes()` | `ws.secrets.list_acls(scope_name)`           | `ws.secrets.put_acl`                            | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workspace     | Notebooks          | `object_id`        | custom listing             | `ws.permissions.get`                         | `ws.permissions.update`                         | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workspace     | Directories        | `object_id`        | custom listing             | `ws.permissions.get`                         | `ws.permissions.update`                         | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workspace     | Repos              | `object_id`        | custom listing             | `ws.permissions.get`                         | `ws.permissions.update`                         | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |
| Workspace     | Files              | `object_id`        | custom listing             | `ws.permissions.get`                         | `ws.permissions.update`                         | `databricks.sdk.service.iam.ObjectPermissions` |                                                                                                            |